{% extends "settings/layout.html" %}

{% block content %}
<style>
  .device-module {
    padding: 1rem;
    border: 1px solid var(--pico-muted-border-color);
    border-radius: var(--pico-border-radius);
    margin-bottom: 1rem;
  }
  .device-module.added {
    border-color: var(--pico-ins-color);
    opacity: 0.75;
  }
  .device-module header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 0.5rem;
  }
  .device-module form {
    display: flex;
    gap: 0.5rem;
    align-items: center;
  }
  .device-module select {
    width: auto;
    margin: 0;
    padding: 0.25rem 0.5rem;
  }
  .device-module button {
    margin: 0;
    padding: 0.25rem 0.75rem;
  }
</style>

<header style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
  <hgroup style="margin: 0;">
    <h2 style="margin: 0;">Add Netatmo Sensor</h2>
    <p style="margin: 0;">Select a device from your Netatmo account to add as a sensor.</p>
  </hgroup>
  <a href="/settings/netatmo/" role="button" class="secondary outline">Back</a>
</header>

{% if not locations %}
  <div class="alert alert-warning">
    You need to <a href="/settings/locations/new/">create a location</a> before adding sensors.
  </div>
{% elif not stations %}
  <div class="alert alert-info">
    No Netatmo devices found. Make sure your weather station is set up in the Netatmo app.
  </div>
{% else %}
  {% for station in stations %}
    <article>
      <header>
        <strong>{{ station.station_name }}</strong>
        {% if station.place and station.place.city %}
          <small>- {{ station.place.city }}</small>
        {% endif %}
      </header>

      <div class="device-module {% if station.id in registered_ids %}added{% endif %}">
        <header>
          <div>
            <strong>{{ station.module_name }}</strong>
            <p style="margin: 0;">
              <span class="badge">{{ station.type }}</span>
              <small>Indoor module - Temperature, Humidity, CO2, Noise, Pressure</small>
            </p>
          </div>
          {% if station.id in registered_ids %}
            <span class="badge badge-success">Added</span>
          {% else %}
            <form action="/settings/netatmo/devices/add/" method="post">
              <input type="hidden" name="device_id" value="{{ station.id }}">
              <input type="hidden" name="device_name" value="{{ station.module_name }}">
              <input type="hidden" name="module_type" value="{{ station.type }}">
              <input type="hidden" name="station_id" value="{{ station.id }}">
              <select name="location_id" required>
                <option value="">Location...</option>
                {% for location in locations %}
                  <option value="{{ location.id }}">{{ location.name }}</option>
                {% endfor %}
              </select>
              <button type="submit">Add</button>
            </form>
          {% endif %}
        </header>
      </div>

      {% if station.modules %}
        {% for module in station.modules %}
          <div class="device-module {% if module.id in registered_ids %}added{% endif %}">
            <header>
              <div>
                <strong>{{ module.module_name }}</strong>
                <p style="margin: 0;">
                  <span class="badge">{{ module.type }}</span>
                  <small>
                    {% if module.type == 'NAModule1' %}
                      Outdoor module - Temperature, Humidity
                    {% elif module.type == 'NAModule2' %}
                      Wind module - Wind speed, direction, gusts
                    {% elif module.type == 'NAModule3' %}
                      Rain module - Rain accumulation
                    {% elif module.type == 'NAModule4' %}
                      Indoor module - Temperature, Humidity, CO2
                    {% else %}
                      Additional module
                    {% endif %}
                  </small>
                </p>
              </div>
              {% if module.id in registered_ids %}
                <span class="badge badge-success">Added</span>
              {% else %}
                <form action="/settings/netatmo/devices/add/" method="post">
                  <input type="hidden" name="device_id" value="{{ module.id }}">
                  <input type="hidden" name="device_name" value="{{ module.module_name }}">
                  <input type="hidden" name="module_type" value="{{ module.type }}">
                  <input type="hidden" name="station_id" value="{{ station.id }}">
                  <select name="location_id" required>
                    <option value="">Location...</option>
                    {% for location in locations %}
                      <option value="{{ location.id }}">{{ location.name }}</option>
                    {% endfor %}
                  </select>
                  <button type="submit">Add</button>
                </form>
              {% endif %}
            </header>
          </div>
        {% endfor %}
      {% endif %}
    </article>
  {% endfor %}
{% endif %}
{% endblock %}
